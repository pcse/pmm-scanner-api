<!doctype html>
<html lang="en-us">
<head>
<meta charset="utf-8" />
<title>Pizza My Mind API</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.css" />
<link rel="stylesheet" href="/static/reset.css"/>
<link rel="stylesheet" href="/static/styles.css"/>
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/randomcolor/0.4.1/randomColor.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
/**
 * Pizza My Mind API Client
 * @juanvallejo
 * 
 * TODO: Split into separate files based on objects / prototypes
 * TODO: Handle WebSocket disconnect error or connection fail
 */

var serverURL = 'http://fenrir.pcs.cnu.edu:7777';
var socket = null;

// timeout for displaying notice after no response from server
var pageLoadingErrorTimeout = null;

var response_callbacks = {};

// Change these values to whatever Clare says.
var NUM_EVENTS_FULL_CREDIT = 13;
var NUM_EVENTS_HALF_CREDIT = 10;

if(window.location.hostname == 'localhost') {
	serverURL = 'http://localhost:7777';
}

try {
	socket = io.connect(serverURL);
} catch(e) {
	console.log('Error connecting to server.');
}

if(socket) {

	// admin has requested api access
	socket.on('registerapiemailresponse', function(data) {
		emitSuccessfulServerResponse(data);
		handleServerEmailRegisterResponse(data);
	});

	// student has requested to log in
	socket.on('registerapistudentidresponse', function(data) {
		emitSuccessfulServerResponse(data);
		handleServerStudentRegisterResponse(data);
	});

	// student has logged in, has requested survey questions
	socket.on('registerapistudentidsurveyresponse', function(data) {
		emitSuccessfulServerResponse(data);
		handleServerStudentRegisterSurveyResponse(data);
	});

	// admin has requested to log in
	socket.on('registerapiauthadminresponse', function(data) {
		emitSuccessfulServerResponse(data);
		handleServerAdminRegisterResponse(data);
	});

	// client has asked for database timestamp
	socket.on('registerapistudentidlastupdatedresponse', function(data) {
		emitSuccessfulServerResponse(data);
		handleStudentRegisterLastUpdatedResponse(data);
	});

	// student has requested last saved crn response
	socket.on('registerapistudentcrnresponse', function(data) {
		emitSuccessfulServerResponse(data);
		callEventCallbacks('registerapistudentcrnresponse', data);
	});

	// client has requested spreadsheet generation from data
	socket.on('registerapiadmindownloadspreadsheetresponse', function(data) {
		emitSuccessfulServerResponse(data);
		callEventCallbacks('registerapiadmindownloadspreadsheetresponse', data);
	});

	// client has requested submission of survey questions
	socket.on('registerapistudentsurveysubmitresponse', function(data) {
		emitSuccessfulServerResponse(data);
		callEventCallbacks('registerapistudentsurveysubmitresponse', data);
	});
	
	// client has requested survey response data
	socket.on('registerapiadminsurveydataresponse', function(data) {
		emitSuccessfulServerResponse(data);
		callEventCallbacks('registerapiadminsurveydataresponse', data);
	});

	// client has requested survey response data
	socket.on('registerapiadminstudentdataresponse', function(data) {
		emitSuccessfulServerResponse(data);
		callEventCallbacks('registerapiadminstudentdataresponse', data);
	});

}

function emitSuccessfulServerResponse(data) {
	clearTimeout(pageLoadingErrorTimeout);
}

function callEventCallbacks(eventName, data) {
	for(var i = 0; i < response_callbacks[eventName].length; i++) {
		response_callbacks[eventName][i].call(this, data);
		if(response_callbacks[eventName][i].is_unique) {
			response_callbacks[eventName].splice(i, 1);
		}
	}
}

/**
 * Handle callback functions for specific server responses
 */
function onSocketResponse(eventName, callback, unique) {

	if(!(typeof callback == 'function')) {
		return;
	}

	callback.is_unique = unique || false;

	if(!response_callbacks[eventName]) {
		response_callbacks[eventName] = [];
	}

	response_callbacks[eventName].push(callback);

}

</script>
</head>
<body>
<div id="main-panel" class="panel">
	<div class="fx-shadow-overlay"></div><!--#fx-shadow-overlay-->
	<div class="wrapper">
		<div id="brand">
			<!-- <p class="logo">Scan Your ID</p>
			<p class="tagline">Please scan your ID to continue</p> -->
		</div><!--#brand-->

		<div class="stats" id="stats1">
			<div class="stats-out" id="stats1Out"></div><!--.stats-out-->
		</div><!--.circle-->

		<div class="panel-content">
			<div class="editor">
				<div class="editor-wrapper">
					<div class="editor-content Bloom-colorize">
						<!-- <div id="sid"></div> -->
						<input type="text" placeholder="Type your ID" id="sid-input" />
					</div><!--.editor-content-->
				</div><!--.editor-wrapper-->
			</div><!--.editor-->
		</div><!--.panel-content-->

		<div id="out">Made with <span class="fa fa-heart"></span> for the PCSE department</div>

	</div><!--#home-page-->

</div><!--#main-panel-->

<div class="panel" id="results-panel">
	<div class="nav-bar">
		<div class="nav-bar-logo"></div>
		<div class="nav-bar-text">Pizza My Mind API</div>
		<div class="nav-bar-exit" id="close-button"><span class="fa fa-close fa-lg"></span></div>
	</div><!--.nav-bar -->
	<div class="wrapper">
		<div class="panel-content">
			<div class="editor">
				<div class="editor-wrapper">
					<div class="editor-content" id="results-content">
						Loading, please wait....
					</div><!--.editor-content-->
				</div><!--.editor-wrapper-->
			</div><!--.editor-->
		</div><!--.panel-content-->
	</div><!--.wrapper-->
</div><!--.panel-->
<div id="overlay"></div><!--#overlay-->
<script>

var DEBUG = false;
var DEBUG_STUDENT_ID = '000000001';

var TIMESTAMP_END = 1544652000000; // sets deadline for registering class extra credit.
								   // In MILLISECONDS
						           // set to 'null' to have no deadline

var DEFAULT_MAIN_OUTPUT_PLACEHOLDER = 'Enter your email';
var PAGE_HOME = 'home';
var PAGE_REGISTER = 'register';
var PAGE_ADMIN = 'admin';
var PAGE_ADMIN_AUTH = 'admin_auth';

// question type definitions
var SURVEY_QUESTION_MULT_CHOICE = 1;
var SURVEY_QUESTION_FREE_RESP 	= 2;

var closeButton = document.getElementById('close-button');

var mainInput = document.getElementById('sid-input');
var mainOutput = document.getElementById('out');
var urlPieces = window.location.href.split('/api/');

var resultsPage = document.getElementById('results-panel');
var resultsContent = document.getElementById('results-content');
var homePage = document.getElementById('main-panel');

// application states
var isMainPage 				= false;
var isAdminEmailEntered 	= false;
var isAdminHashkeyEntered 	= false;
var isPage = PAGE_HOME;

var currentStudentId 		= null;

var extraCreditInputShowing = false;
var eventsTableStudentEmailShowing = false;

// page events
$(window).on('keydown', function(key) {

	if(key.keyCode == 27) {
		key.preventDefault();

		if(extraCreditInputShowing) {
			extraCreditInputShowing = false;
			return $('.extra-credit-input').fadeOut('normal');
		}

		if(eventsTableStudentEmailShowing) {
			eventsTableStudentEmailShowing = false;
			return $('.events-table-student-email').fadeOut('normal');
		}

		$(closeButton).trigger('click');
	}

});

// focus main input
if(mainInput) {
	mainInput.focus();
	$(mainInput).on('keypress', function(e) {
		handleKeypress(e.keyCode);
	});
}

// handle views based on URL
handleURL(window.location.href);

if(closeButton) {
	$(closeButton).on('click', function() {
		resultsPage.style.display = 'none';
		mainInput.value = '';
		handleViewByPageName(isPage);
	});
}

// determine if url parameters are being used
var params = urlPieces[1] ? urlPieces[1].split('/') : [];

if(!isMainPage && params[1] == 'email' && params[2]) {
	showRegisterResultsPage(params[2]);
}

// if debug use default student ID
if(DEBUG) {
	alert('DEBUG MODE is on');
	console.log('WARN', 'DEBUG mode is on.', 'Please be cautious to set DEBUG mode off before pushing.');
	// showHomeResultsPage(DEBUG_STUDENT_ID);
	// showAdminResultsPage('ADMIN_EMAIL', 'ADMIN_PASSWORD');

	setTimeout(function() {
		function run() { var e = jQuery.Event("keydown", {keyCode: 13}); $('#admin-button-edit-student').click(); $('#admin-button-input-edit-student').val('00000000'); $('#admin-button-input-edit-student').focus(); }
			run();
	}, 400);
}

// replace table id underscores with slashes
function tableIdToDate(id) {
	return id.replace(/\_/gi, '\/');
}

// define general user action-driven callback functions

/**
 * Adds callback function to stack, to be called any time the submit button
 * on the survey page is pressed
 */
function callbackOnSurveySubmitButtonPressed(callback) {

	if(!callbackOnSurveySubmitButtonPressed.callbacks) {
		callbackOnSurveySubmitButtonPressed.callbacks = [];
	}

	callbackOnSurveySubmitButtonPressed.callbacks.push(callback);

}

function handleURL(urlPieces) {

	isMainPage = false;
	
	var urlParams = urlPieces.split(window.location.host);
	var path = urlParams && urlParams.length > 1 ? urlParams[1] : null;
	
	if(path == '/api/register') {
		handleRegistrationView();
	} else if(path == '/clare' || path == '/admin') {
		handleAdminView();
	} else {
		handleMainView();
	}

}

function handleViewByPageName(isPage) {

	if(isPage == PAGE_ADMIN_AUTH) {
		handleLoggedInAdminView();
	} else if(isPage == PAGE_ADMIN) {
		handleAdminView();
	} else if(isPage == PAGE_REGISTER) {
		handleRegistrationView();
	} else {
		handleMainView();
	}

}

function handleMainView() {

	DEFAULT_MAIN_OUTPUT_PLACEHOLDER = 'Type your ID';

	isMainPage = true;
	isPage = PAGE_HOME;

	homePage.style.display = 'block';

	if(mainInput) {
		mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
		mainInput.focus();
	}
}

function handleRegistrationView() {

	isPage = PAGE_REGISTER;
	DEFAULT_MAIN_OUTPUT_PLACEHOLDER = 'Enter your email';
	
	if(!mainInput || !mainOutput) {
		return;
	}

	homePage.style.display = 'block';
	
	mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
	mainOutput.innerHTML = 'Press ENTER To continue signing up';
}

function handleLoggedInAdminView() {

	isPage = PAGE_ADMIN;
	
	if(!mainInput.valueAdminHashKey || !mainInput.valueAdminEmail) {
		return handleAdminView();
	}

	showAdminResultsPage(mainInput.valueAdminEmail, mainInput.valueAdminHashKey);

}

function handleAdminView() {

	isPage = PAGE_ADMIN;
	DEFAULT_MAIN_OUTPUT_PLACEHOLDER = 'Enter your email';

	if(!mainInput || !mainOutput) {
		return;
	}

	homePage.style.display = 'block';
	
	mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
	mainOutput.innerHTML = 'Press ENTER To continue';
}

function handleAdminAuthentication() {

	if(!isPage == PAGE_ADMIN) {
		return;
	}

	if(isAdminEmailEntered) {

		// determine if admin has entered api key
		// and authenticate with api server
		if(isAdminHashkeyEntered) {

			// reset admin state values
			isAdminEmailEntered 		= false;
			isAdminHashkeyEntered 		= false;

			// display results page and wait for server response
			showAdminResultsPage(mainInput.valueAdminEmail, mainInput.valueAdminHashKey);

			// reset admin input
			// mainInput.valueAdminEmail 	= null;
			// mainInput.valueAdminHashKey = null;
			mainInput.type 				= 'text';

			return;
		}

		// if we made it this far, admin has entered email
		// and is submitting hashkey.
		mainInput.valueAdminHashKey = mainInput.value;
		isAdminHashkeyEntered = true;
		handleAdminAuthentication();
		return;
	}

	// if we made it this far, email has not been entered.
	// check input value for a valid email string
	if(!mainInput.value.match(/^[a-z\-\_\.]+(\.[0-9]+)*\@(cnu\.edu)/gi)) {
		mainInput.value = '';
		return mainInput.placeholder = 'Please enter a valid email';
	}

	// assume admin email is of correct format. Save it and continue reg process
	mainInput.valueAdminEmail = mainInput.value;
	isAdminEmailEntered = true;

	mainInput.value = '';
	mainInput.placeholder = 'Enter your API key';
	mainInput.type = 'password';

}

// display alert message
function showAlert(text, duration) {

	if(!showAlert.container) {

		showAlert.container = document.createElement('div');
		showAlert.container.className = 'alert-banner-top';

		$(showAlert.container).on('click', function() {
			clearTimeout(showAlert.container.timeout);
			$(this).fadeOut();
		});

		document.body.appendChild(showAlert.container);
	}

	$(showAlert.container).fadeIn();
	showAlert.container.innerHTML = text;

	clearTimeout(showAlert.container.timeout);
	showAlert.container.timeout = setTimeout(function() {
		$(showAlert.container).fadeOut();
	}, duration || 100000);

}

/**
 * Sets "loading, please wait..." text and a timeout event
 * to display a loading error after 8 seconds of no reply from
 * the server due to socket connection issues
 */
function setPageLoadingTimeout(div) {
	div.innerHTML = 'Loading, please wait...';
	clearTimeout(pageLoadingErrorTimeout);
	pageLoadingErrorTimeout = setTimeout(function() {
		div.innerHTML = 'Hm, something is not right. If you are experiencing trouble loading this content, \
		refresh this page and try again.<br /><br />Please note that you MUST use WiFi-CNU to access this content.';
	}, 8000);
}

// display all student event and course selection data
// for selected admin with email, key combination
function showAdminResultsPage(email, key) {

	mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
	homePage.style.display = 'none';
	resultsPage.style.display = 'block';

	// set loading sign, handle no response from server
	setPageLoadingTimeout(resultsContent);

	if(socket) {
		socket.emit('registerapiauthadmin', {
			email: email,
			hash: key
		});
	
	}

}

function showRegisterResultsPage(email) {

	mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
	homePage.style.display = 'none';
	resultsPage.style.display = 'block';

	setPageLoadingTimeout(resultsContent);

	if(socket) {
		socket.emit('registerapiemail', {
			email: email
		});
	
	}
}

// display events for selected student id
function showHomeResultsPage(studentId) {

	// save to return to this page later
	currentStudentId = studentId;

	mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
	homePage.style.display = 'none';
	resultsPage.style.display = 'block';

	setPageLoadingTimeout(resultsContent);

	if(socket) {
		socket.emit('registerapistudentid', {
			id: studentId,
			context: 'general'
		});
	
	}
}

// display survey questions for selected student id
function showHomeSurveyPage(studentId) {

	mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
	homePage.style.display = 'none';
	resultsPage.style.display = 'block';

	setPageLoadingTimeout(resultsContent);

	if(socket) {
		socket.emit('registerapistudentidsurvey', {
			id: studentId
		});
	
	}

}

// received when data for a student id is requested by an admin
function handleServerAdminStudentDataResponse(data) {

	isPage = PAGE_ADMIN_AUTH;

	if(data.error) {
		return showAlert('An error occurred while contacting the authentication server. Please try again later. (' + data.message + ')', 5000);
	}

	// if we have made it this far, assume the user logged in correctly
	// assume data has rows
	if(!data.entries) {
		return showAlert('Unable to fetch event data from the database.', 5000);
	}

	resultsContent.innerHTML = '';

	var student = {
		id: data.student_id,
		name: data.student_id,
		crn: null,
		crncourse: null,
		crntitle: null,
		email: null,
		survey: null,
		events: [],
		all_events: {}
	}

	// loop through all entries to determine if exists
	for(var i = 0; i < data.entries.length; i++) {
		
		if(data.entries[i].first && student.name == data.student_id) {
			student.name = data.entries[i].first + ' ' + data.entries[i].last;
		}

		if(!student.crn && data.entries[i].crn) {
			student.crn = data.entries[i].crn;
		}

		if(!student.crncourse && data.entries[i].crncourse) {
			student.crncourse = data.entries[i].crncourse;
		}

		if(!student.crntitle && data.entries[i].crntitle) {
			student.crntitle = data.entries[i].crntitle;
		}

		if(!student.email && data.entries[i].email) {
			student.email = data.entries[i].email;
		}

		if(!student.major && data.entries[i].major) {
			student.major = data.entries[i].major;
		}

		if(!student.gradyear && data.entries[i].gradyear) {
			student.gradyear = data.entries[i].gradyear;
		}

		if(!student.survey && data.entries[i].survey) {
			student.survey = true;
		}

		// determine if event is valid
		if(data.entries[i].id != null) {
			student.events.push({
				event_id: data.entries[i].event_id,
				event_name: data.entries[i].event_name,
				year: data.entries[i].year,
				semester: data.entries[i].semester
			});
		}

		if(student.all_events[data.entries[i].event_id]) {
			continue;
		}

		student.all_events[data.entries[i].event_id] = {
			attended: data.entries[i].id ? true : false,
			event_id: data.entries[i].event_id,
			event_name: data.entries[i].event_name,
			year: data.entries[i].year,
			semester: data.entries[i].semester
		};


	}

	// student profile header container
	var studentDataHeaderContainer = document.createElement('div');
	studentDataHeaderContainer.className = 'survey-data-container';
	studentDataHeaderContainer.id = 'student-data-header-container';

	// loop through all entries to determine
	if(student.name && student.email) {
		studentDataHeaderContainer.innerHTML = '<a href="mailto:' + student.email + '">' + student.name + '</a> (' + student.id + ')';
	} else {
		studentDataHeaderContainer.innerHTML = student.name;
	}

	resultsContent.appendChild(studentDataHeaderContainer);

	// student information container
	var studentDataBodyContainer = document.createElement('div');
	studentDataBodyContainer.className = 'survey-data-container';
	studentDataBodyContainer.id = 'student-data-body-container';

	var hasSurvey = student.survey ? '' : 'not';
	var studentDataText = '';
	if(student.events.length > 7) {
		studentDataText += 'This student is eligible for extra credit, has attended ' + student.events.length + ' events this semester, and has ' + hasSurvey + ' submitted the extra credit survey. ';
	} else {
		studentDataText += 'This student is not eligible for extra credit, and has been to ' + student.events.length + ' events this semester. ';
	}

	if(student.major && student.gradyear) {
		studentDataText += 'They are currently majoring in ' + student.major + ', with a graduation year in ' + student.gradyear + '.';
	}

	studentDataBodyContainer.innerHTML = studentDataText;
	resultsContent.appendChild(studentDataBodyContainer);

	var studentEventBodyContainer = document.createElement('div');
	studentEventBodyContainer.className = 'survey-data-container';

	var table = document.createElement('table');
	table.className = 'events-table';
	table.border = '0';

	studentEventBodyContainer.appendChild(table);

	for(var i in student.all_events) {

		var tr = document.createElement('tr');
		var color = randomColor({
			luminosity: 'light',
			hue: 'blue'
		});

		if(!student.all_events[i].attended) {
			color = 'rgba(255,255,255,0.25); text-decoration:line-through';
		} 
		
		tr.innerHTML = '<td style="color:' + color + ';">' + tableIdToDate(student.all_events[i].event_id) + '</td>';
		tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + student.all_events[i].event_name + '</td>';

		table.appendChild(tr);
	}

	resultsContent.appendChild(studentEventBodyContainer);

}

// received when an admin is authenticated with the
// server, or when an admin authentication response
// is received from the server
function handleServerAdminRegisterResponse(data) {
	
	if(data.error) {
		if(!data.authenticated) {
			return resultsContent.innerHTML = 'Incorrect email or API key. Please try again, or email <a href="mailto:clarem@cnu.edu">clarem@cnu.edu</a> for more information. This incident will be logged.';
		}

		return resultsContent.innerHTML = 'An error occurred while contacting the authentication server. Please try again later. (' + data.message + ')';
	}

	// if we have made it this far, assume the user logged in correctly
	// assume data has rows
	if(!data.entries) {
		return resultsContent.innerHTML = 'Unable to fetch event data from the database.';
	}

	var students = {};
	var studentCount = 0;

	for(var i = 0; i < data.entries.length; i++) {

		// initialize array for entry if not exists
		if(!students[data.entries[i].id]) {
			students[data.entries[i].id] = {
				id: data.entries[i].id,
				last: data.entries[i].last,
				first: data.entries[i].first,
				email: data.entries[i].email,
				gradyear: data.entries[i].gradyear,
				//crn: data.entries[i].crn,
				events:[],
				event_ids: {}
			};

			studentCount++;
		}

		// add new event if not added yet
		if(students[data.entries[i].id].event_ids[data.entries[i].event_id]) {
			continue;
		}

		students[data.entries[i].id].event_ids[data.entries[i].event_id] = true;
		students[data.entries[i].id].events.push({
			event_id: data.entries[i].event_id,
			event_name: data.entries[i].event_name,
			year: data.entries[i].year,
			semester: data.entries[i].semester
		});
	}

	resultsContent.innerHTML = '';

	// admin actions container (buttons)
	var adminActionsContainer = document.createElement('div');
	adminActionsContainer.className = 'survey-data-container buttons-container';
	adminActionsContainer.id = 'admin-actions-container';
	
	resultsContent.appendChild(adminActionsContainer);

	// create extra credit stats container
	var extraCreditStatsContainer = document.createElement('div');
	extraCreditStatsContainer.className = 'survey-data-container';
	extraCreditStatsContainer.id = 'extra-credit-data-container';
	extraCreditStatsContainer.innerHTML = 'Welcome, loading extra credit data, please wait...';
	
	resultsContent.appendChild(extraCreditStatsContainer);

	// create survey stats container
	var surveyDataContainer = document.createElement('div');
	surveyDataContainer.className = 'survey-data-container';
	surveyDataContainer.id = 'survey-data-container';
	surveyDataContainer.innerHTML = 'Welcome, loading survey data, please wait...';
	
	resultsContent.appendChild(surveyDataContainer);

	/**
	 * Section one - students with two points of ec
	 */

	var sectionOneStudents = [];
	var sectionTwoStudents = [];
	var sectionThreeStudents = [];

	// create admin actions section buttons
	var adminButtonEditStudent = document.createElement('span');
	adminButtonEditStudent.className = 'admin-button';
	adminButtonEditStudent.id = 'admin-button-edit-student';
	adminButtonEditStudent.innerHTML = '<span class="fa fa-clipboard">&nbsp;&nbsp;</span>Edit A Student Profile';

	adminButtonEditStudentInput = document.createElement('input');
	adminButtonEditStudentInput.className = 'admin-button-input';
	adminButtonEditStudentInput.id = 'admin-button-input-edit-student';
	adminButtonEditStudentInput.placeholder = 'Enter a student ID...';

	adminActionsContainer.appendChild(adminButtonEditStudent);
	adminActionsContainer.appendChild(adminButtonEditStudentInput);

	adminButtonEditStudent._input = adminButtonEditStudentInput;

	// create top text
	var ecStudentCount = 0;
	var tableSpan = document.createElement('span');
	tableSpan.innerHTML = 'Loading, please wait...';

	resultsContent.appendChild(tableSpan);	

	// draw table of students with the events required for full credit
	var table = document.createElement('table');
	table.className = 'events-table';
	table.border = '0';

	for(var i in students) {

		if(students[i].events.length < NUM_EVENTS_FULL_CREDIT) {
			continue;
		}

		ecStudentCount++;
		sectionOneStudents.push(students[i]);

		var tr = document.createElement('tr');
		var color = randomColor({
			luminosity: 'light',
			hue: 'blue'
		});

		tr.innerHTML = '<td style="color:' + color + ';min-width:225px;"><span class="events-table-student-email"><a href="mailto:' + students[i].email + '">' + students[i].email + '</a></span><span class="events-table-student-entry">' + students[i].first + ' ' + students[i].last + '</span></td>';
		tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + students[i].events.length + ' events' + '</td>';
		tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + (students[i].crn ? students[i].crn : '<span style="opacity:0.45;">No course chosen</span>') + '</td>';
		table.appendChild(tr);
	}

	resultsContent.appendChild(table);

	// update stats
	tableSpan.innerHTML = 'Displaying <span style="color:rgb(189,224,216)">' + ecStudentCount + ' students</span> that have earned <span style="color:rgb(224,189,215);">two points of extra credit</span> and have gone to <span style="color:#7ce2ef;">' + NUM_EVENTS_FULL_CREDIT +' or more events</span>. <span id="students_extra_credit_2" class="download-excel download-excel-two-points">Click to <span style="color:#b4a9fc;">download spreadsheet</span></span>.';


	// separate last section from new section
	resultsContent.innerHTML += '<div class="spacer"></div>';

	/**
	 * Section two - students with one point of ec
	 */

	// create view for students with one point of extra credit
	// reset count and dom pointers
	ecStudentCount = 0;
	tableSpan = document.createElement('span');
	tableSpan.innerHTML = 'Loading, please wait...';

	resultsContent.appendChild(tableSpan);

	// draw table of students with events required for half credit
	table = document.createElement('table');
	table.className = 'events-table';
	table.border = '0';

	for(var i in students) {

		if(students[i].events.length < NUM_EVENTS_HALF_CREDIT || students[i].events.length > NUM_EVENTS_FULL_CREDIT-1) {
			continue;
		}

		ecStudentCount++;
		sectionTwoStudents.push(students[i]);

		var tr = document.createElement('tr');
		var color = randomColor({
			luminosity: 'light',
			hue: 'blue'
		});

		tr.innerHTML = '<td style="color:' + color + ';min-width:225px;"><span class="events-table-student-email"><a href="mailto:' + students[i].email + '">' + students[i].email + '</a></span><span class="events-table-student-entry">' + students[i].first + ' ' + students[i].last + '</span></td>';
		tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + students[i].events.length + ' events' + '</td>';
		tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + (students[i].crn ? students[i].crn : '<span style="opacity:0.45;">No course chosen</span>') + '</td>';
		table.appendChild(tr);
	}

	resultsContent.appendChild(table);

	// update stats
	tableSpan.innerHTML = 'Displaying <span style="color:rgb(189,224,216)">' + ecStudentCount + ' students</span> that have earned <span style="color:rgb(224,189,215);">one point of extra credit</span> and have gone to <span style="color:#7ce2ef;">' + NUM_EVENTS_HALF_CREDIT + ' or more events</span>. <span id="students_extra_credit_1" class="download-excel download-excel-one-point">Click to <span style="color:#b4a9fc;">download spreadsheet</span></span>.';

	// separate last section from new section
	resultsContent.innerHTML += '<div class="spacer"></div>';

	/**
	 * Section three - students with no points of ec
	 */

	// create view for students with zero point of extra credit
	// reset count and dom pointers
	ecStudentCount = 0;
	tableSpan = document.createElement('span');
	tableSpan.innerHTML = 'Loading, please wait...';

	resultsContent.appendChild(tableSpan);

	// draw table of students with events required for half credit
	table = document.createElement('table');
	table.className = 'events-table';
	table.border = '0';

	for(var i in students) {

		if(students[i].events.length > 7) {
			continue;
		}

		ecStudentCount++;
		sectionThreeStudents.push(students[i]);

		var tr = document.createElement('tr');
		var color = randomColor({
			luminosity: 'light',
			hue: 'blue'
		});

		tr.innerHTML = '<td style="color:' + color + ';min-width:225px;"><span class="events-table-student-email"><a href="mailto:' + students[i].email + '">' + students[i].email + '</a></span><span class="events-table-student-entry">' + students[i].first + ' ' + students[i].last + '</span></td>';
		tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + students[i].events.length + ' events' + '</td>';
		tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + (students[i].crn ? students[i].crn : '<span style="opacity:0.45;">No course chosen</span>') + '</td>';
		table.appendChild(tr);
	}

	resultsContent.appendChild(table);

	// update stats
	tableSpan.innerHTML = 'Displaying <span style="color:rgb(189,224,216)">' + ecStudentCount + ' students</span> that have earned <span style="color:rgb(224,189,215);">zero points of extra credit</span> and have gone to <span style="color:#7ce2ef;">less than ' + NUM_EVENTS_HALF_CREDIT + ' events</span>. <span id="students_extra_credit_0" class="download-excel download-excel-no-points">Click to <span style="color:#b4a9fc;">download spreadsheet</span></span>.';

	// add event listeners to table rows
	$('.events-table-student-entry').on('click', function() {
		eventsTableStudentEmailShowing = true;
		$(this.parentNode.getElementsByClassName('events-table-student-email').item(0)).fadeIn('normal');
	});

	// add event listener to admin buttons
	$('#admin-button-edit-student').on('click', function() {
		$(this).fadeOut('fast', function() {
			//console.log(document.getElementById('admin-button-edit-student')._input);
			$('#admin-button-input-edit-student').fadeIn('fast').focus().on('keypress', function(e) {

				if(e. keyCode != 13) {
					return;
				}

				if(!this.value.match(/^[0-9]{8,10}$/gi)) {
					return showAlert('Please enter a valid student ID', 5000);
				}

				var that = this;
				that._placeholder = that.placeholder;
				that.placeholder = 'Loading, please wait...';

				socket.emit('registerapiadminstudentdata', { id: that.value });	
				
				that.value = '';

				// receive and parse individual student data on the admin page
				onSocketResponse('registerapiadminstudentdataresponse', function(data) {
					
					if(that._placeholder) {
						that.placeholder = that._placeholder;
					}

					handleServerAdminStudentDataResponse(data);

				}, true);

			});
		});
				
	});

	// request survey data
	socket.emit('registerapiadminsurveydata');

	// receive and parse survey and extra credit data
	// we do it here so that we can add download click listener to spreadsheet link
	onSocketResponse('registerapiadminsurveydataresponse', function(data) {

		var surveyResponseCount = 0;

		// entries by sutdent_id
		var responses = {};
		var surveyParsedResponses = [];

		var surveyQuestions = {};
		var surveyChoiceStats = {};

		// populate questions array

		for(var i = 0; i < data.entries.length; i++) {

			// save unique survey questions for later use
			if(!surveyQuestions[data.entries[i].question_id]) {
				surveyQuestions[data.entries[i].question_id] = {
					question_id: data.entries[i].question_id,
					question: data.entries[i].question,
					responses: []
				}
			}

			// parse response stats
			if(data.entries[i].choice_id) {
				if(!surveyChoiceStats[data.entries[i].choice_id]) {
					surveyChoiceStats[data.entries[i].choice_id] = {
						count: 0,
						text: data.entries[i].choice,
						question: data.entries[i].question,
						question_id: data.entries[i].question_id,
						percent: 0.0
					}
				}

				surveyChoiceStats[data.entries[i].choice_id].count++;
			}

			// instantiate object.
			// choices holds either a text response or a choice
			if(!responses[data.entries[i].student_id]) {

				surveyResponseCount++;

				responses[data.entries[i].student_id] = {
					student_id: data.entries[i].student_id,
					last: data.entries[i].student_last,
					first: data.entries[i].student_first,
					major: data.entries[i].student_major,
					email: data.entries[i].student_email
				};
			}

			if(!data.entries[i].choice) {
				data.entries[i].choice = data.entries[i].text_response;
			}

			responses[data.entries[i].student_id][data.entries[i].question] = data.entries[i].choice;

		}

		// populate responses
		for(var i in surveyChoiceStats) {
			surveyQuestions[surveyChoiceStats[i].question_id].responses.push(surveyChoiceStats[i]);
		}

		// get longest question response count
		var surveyQuestionResultMaxCount = 0;
		for(var i in surveyQuestions) {
			if(surveyQuestions[i].responses.length > surveyQuestionResultMaxCount) {
				surveyQuestionResultMaxCount = surveyQuestions[i].responses.length;
			}
		}

		// populate the first four rows of our results with stats for each
		// question's choices
		for(var x = 0; x < surveyQuestionResultMaxCount + 1; x++) {

			var surveyParsedResponsesStats = {
				student_id: '',
				last: '',
				first: '',
				major: '',
				email: ''
			}

			for(var i in surveyQuestions) {

				if(!surveyQuestions[i].responses.length || !surveyQuestions[i].responses[x]) {
					surveyParsedResponsesStats[surveyQuestions[i].question] = '';
					continue;
				}

				surveyParsedResponsesStats[surveyQuestions[i].question] = surveyQuestions[i].responses[x].text + '  (' + surveyQuestions[i].responses[x].count + ' students) [' + parseInt(surveyQuestions[i].responses[x].count / surveyResponseCount * 100) + '%]';
			}

			surveyParsedResponses.push(surveyParsedResponsesStats);
		}

		// save actual responses
		for(var i in responses) {
			surveyParsedResponses.push(responses[i]);
		}

		// Append extra credit container information here as well. This is so that the click
		// event listener is applied to all links, regardless of which one loads first.
		$('#extra-credit-data-container').html('');
		$('#extra-credit-data-container').append('Welcome, A total of <span style="color:#9a99ff;">' + data.ecEntries.length + ' students have chosen a course</span> for their extra credit.');
		$('#survey-data-container').html('A total of <span style="color:#9a99ff;">' + surveyResponseCount + ' students have completed surveys</span>.');
			
		if(surveyParsedResponses.length) {
			$('#survey-data-container').append(' <span class="download-excel" id="students_survey_data">Click to <span style="color:#76dffc;">download spreadsheet.</span></span>');
		}

		if(data.ecEntries.length) {
			$('#extra-credit-data-container').append(' <span class="download-excel" id="students_extracredit_data">Click to <span style="color:#76dffc;">download spreadsheet.</span></span>');
		}

		// append event listener here since these links are
		// the last one to load
		$('.download-excel').on('click', function() {

			if(this.isBusy) {
				return;
			}

			var that = this;
			var clientData = {
				filename: 'students_extra_credit_NOpts.csv',
				entries: sectionThreeStudents
			};

			if(this.id == 'students_extra_credit_2') {
				clientData.filename = 'students_extra_credit_2pts.csv';
				clientData.entries = sectionOneStudents;
			} else if(this.id == 'students_extra_credit_1') {
				clientData.filename = 'students_extra_credit_1pts.csv';
				clientData.entries = sectionTwoStudents;
			} else if(this.id == 'students_survey_data') {
				clientData.filename = 'students_survey_responses.csv';
				clientData.entries = surveyParsedResponses;
			} else if(this.id == 'students_extracredit_data') {
				clientData.filename = 'students_extracredit_responses.csv';
				clientData.entries = data.ecEntries;
			}

			this.isBusy = true;
			$(this).animate({ opacity: 0.5 }, 500);

			// send data to server, wait for response
			// containing url to generated xlsx file
			socket.emit('registerapiadmindownloadspreadsheet', clientData); 

			onSocketResponse('registerapiadmindownloadspreadsheetresponse', function(data) {
				that.isBusy = false;
				$(that).animate({ opacity: 1.0 }, 500);
				window.location.assign(data.url);
			}, true);

		});

	}, true);

}

/**
 * Called once the client returns database update data
 * Should only be called once per results page
 */
function handleStudentRegisterLastUpdatedResponse(data) {

	if(!data.timestamp) {
		return
	}

	// convert timestamp to date
	var date = new Date(parseInt(data.timestamp));

	// last updated div
	var divLastUpdated = document.createElement('div');
	divLastUpdated.className = 'events-last-updated';
	divLastUpdated.innerHTML = 'Event data last updated on ' + (date.getMonth() + 1) + '/' + date.getDate() + '/' + date.getFullYear();
	resultsContent.appendChild(divLastUpdated);

}

/**
 * Called once server responds with event data for the current
 * student ID.
 */
function handleServerStudentRegisterResponse(data) {

	// valid entries are ones with non null student ids
	var validEntryCount = 0;

	for(var i = 0; i < data.entries.length; i++) {
		if(!data.entries[i].id) {
			continue;
		}
		validEntryCount++;
	}

	if(data && validEntryCount) {

		var fullName = 'stranger';

		// holds student information of first
		// non null entry returned with student data
		var dataReference = data.entries[0];

		// if we got this far, we have made a request for student data after receiving
		// zero event records last time
		if(data.context == 'students') {
			return resultsContent.innerHTML = '<h1>Welcome, you have not been to <span style="color:rgb(189,198,224);font-weight:bold;">any Pizza My Mind events</span> this semester. Come listen to great companies present opportunities they have to offer <span style="color:rgb(224,189,215);font-weight:bold;">Thursdays at 12:15pm</span> in <span style="color:rgb(189,224,216);font-weight:bold;">Luter 121</span>.</h1>';
		}

		var divCourseInfo = document.createElement('span');
		divCourseInfo.className = 'course-info';

		var extraCredit = 0;
		var plural = 's';
		var evtPlural = 's';

		if(validEntryCount >= NUM_EVENTS_HALF_CREDIT) {
			extraCredit = 1;
			if(validEntryCount >= NUM_EVENTS_FULL_CREDIT) {
				extraCredit = 2;
			}
		}

		if(extraCredit == 1) {
			plural = '';
		}

		if(validEntryCount == 1) {
			evtPlural = '';
		}

		resultsContent.innerHTML = '<h1>Welcome, you have been to <span style="color:rgb(189,198,224);font-weight:bold;">' + validEntryCount + ' event' + evtPlural + '</span> this semester and qualify for <span style="color:rgb(224,189,215);font-weight:bold;">' + extraCredit + ' point' + plural + ' of extra credit</span> in any eligible course.</h1>';

		resultsContent.appendChild(divCourseInfo);

		// draw table
		var table = document.createElement('table');
		table.className = 'events-table';
		table.border = '0';

		// if non-null data is found, populate corresponding
		// variables with it for later use
		for(var i = 0; i < data.entries.length; i++) {

			if(!dataReference.id && data.entries[i].id) {
				dataReference = data.entries[i];
			}

			var tr = document.createElement('tr');
			var color = randomColor({
				luminosity: 'light',
				hue: 'blue'
			});

			if(!data.entries[i].id) {
				color = 'rgba(255,255,255,0.25); text-decoration:line-through';
			}
			
			tr.innerHTML = '<td style="color:' + color + ';">' + tableIdToDate(data.entries[i].event_id) + '</td>';
			tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + data.entries[i].event_name + '</td>';

			table.appendChild(tr);
		}

		resultsContent.appendChild(table);

		// ask server to send database last updated timestamp
		socket.emit('registerapistudentidlastupdated');

		// populate information on course chosen by student
		// only if student is eligible for bonus points
		if(validEntryCount >= NUM_EVENTS_HALF_CREDIT) {

			var extraCreditInput = document.createElement('input');
			extraCreditInput.type = "text";
			extraCreditInput.className = "extra-credit-input";
			extraCreditInput.placeholder = "Enter a Course Registration Number (" + (dataReference.crn ? dataReference.crn : 'CRN') + ")";

			// add input keydown event handler
			$(extraCreditInput).on('keydown', function(key) {

				if(key.keyCode == 13 && this.value != '') {
					
					if(!this.value.match(/^[0-9]{4}$/gi)) {
						this.value = '';
						this.placeholder = 'Please enter a valid CRN';
						return;
					}

					// assume valid crn was entered
					var crn = this.value;
					var old_crn = dataReference.crn;
					this.value = '';
					this.placeholder = "Enter a Course Registration Number (" + (old_crn ? old_crn : 'CRN') + ")";

					$(this).fadeOut('normal');

					// update crn information
					$('.extra-credit-text').html("You are <span style='color:#7ebfea;'>applying extra credit</span> to course <span id='extra-credit-crn' style='color:#77e6ea;'>" + crn + "</span>.");

					

					// ask server to update CRN for current student
					socket.emit('registerapistudentcrn', {
						id: data.id,
						crn: crn
					});

					// prepare for response
					onSocketResponse('registerapistudentcrnresponse', function(data) {

						if(data.error) {
							return $('#extra-credit-crn').html(old_crn);
						}

						extraCreditInput.placeholder = "Enter a Course Registration Number (" + (data.crn ? data.crn : 'CRN') + ")";

						// if data.crndata, assume crn was valid
						// else, warn invalid crn
						if(!data.crndata) {
							return $('.extra-credit-text').html("<span style='color:#cd3700;'>Warning:</span> You are applying extra credit to <span id='extra-credit-crn' style='color:#77e6ea;'>an invalid Course Registration Number (" + data.crn + ")</span>.")
						}

						$('.extra-credit-text').html("You are <span style='color:#7ebfea;'>applying extra credit</span> to <span id='extra-credit-crn' style='color:#77e6ea;'>" + data.crndata.crncourse + (data.crndata.crntitle && data.crndata.crninstructor ? " (" + data.crndata.crntitle + ") by " + data.crndata.crninstructor : ' (' + data.crn + ')') + "</span>.")

					});
				}

			});

			// append crn input
			divCourseInfo.appendChild(extraCreditInput);

			var extraCreditText = document.createElement('h1');
			extraCreditText.className = "extra-credit-text";

			// append crn text
			divCourseInfo.appendChild(extraCreditText);

			// only allow extra credit if student has completed survey
			// else show link for survey
			if(dataReference.survey) {
				extraCreditText.innerHTML = 'You have <span style="color:#7ebfea;">not yet selected a course</span> to apply extra credit.';
			} else {
				extraCreditText.innerHTML = "You <span style='color:#7ebfea;'>must complete the Pizza My Mind survey</span> before applying your extra credit.";
			}

			if(!TIMESTAMP_END || Date.now() < TIMESTAMP_END) {
				extraCreditText.innerHTML += " <span style='color:#77e6ea;'>Click to begin</span>.";
			}

			// A course has been chosen if at least one entry
			// contains a CRN. Check for CRN validity.
			if(dataReference.crn && dataReference.survey) {

				// if we are here, but data.entries[0].crncourse is null, assume invalid crn
				// else, tell chosen course information
				if(!dataReference.crncourse) {
					extraCreditText.innerHTML = "<span style='color:#cd3700;'>Warning:</span> You are applying extra credit to <span id='extra-credit-crn' style='color:#77e6ea;'>an invalid Course Registration Number (" + dataReference.crn + ")</span>.";
				} else {
					extraCreditText.innerHTML = "You are <span style='color:#7ebfea;'>applying extra credit</span> to <span id='extra-credit-crn' style='color:#77e6ea;'>" + dataReference.crncourse + (dataReference.crntitle && dataReference.crninstructor ? " (" + dataReference.crntitle + ") by " + dataReference.crninstructor : ' (' + dataReference.crn + ')') + "</span>.";
				}
			}

			// determine if deadline for class extra credit has been applied
			if(TIMESTAMP_END && Date.now() >= TIMESTAMP_END) {
				extraCreditText.className += ' no-underline';
				return showAlert('You can no longer apply for course extra credit. Please contact clarem@cnu.edu for details.');
			}

			// if we made it this far, assume eligible but has not
			// chosen course yet. Add prompt to choose course
			// extraCreditInput.style.display = "block";
			
			// text event listener
			if(dataReference.survey) {
				
				$(extraCreditText).on('click', function() {
					extraCreditInputShowing = true;
					$(extraCreditInput).fadeIn('normal');
					$(extraCreditInput).focus();
				});

			} else {

				$(extraCreditText).on('click', function() {
					showHomeSurveyPage(data.id);
				});

			}

		}

	} else if(data.context != 'students') {
		// get student data if we received no
		// data initially and we still wish to
		// receive student information with no
		// events->students relationship
		socket.emit('registerapistudentid', {
			id: data.id,
			context: 'students'
		});
	} else {
		// if we have made it this far, the student is not
		// in the database
		resultsContent.innerHTML = '<h1>Hey there, you have not yet shown up to any Pizza My Mind events. Come listen to <span style="color:rgb(189,198,224);font-weight:bold;">great companies</span> <span style="color:rgb(189,224,216);font-weight:bold;">present unique opportunities</span> to students <span style="color:rgb(224,189,215);font-weight:bold;">Thursdays at 12:20pm</span> in <span style="color:rgb(189,224,216);font-weight:bold;">Luter 121</span>.</h1>';
	}
}

/**
 * Called once server responds with survey data for the current
 * student ID.
 */
function handleServerStudentRegisterSurveyResponse(data) {

	var questions = {};
	
	for(var i = 0; i < data.entries.length; i++) {

		if(!questions[data.entries[i].question_id]) {
			questions[data.entries[i].question_id] = {
				student_id: data.id,
				question_id: data.entries[i].question_id,
				question: data.entries[i].question,
				type: data.entries[i].type,
				choices: []
			}
		}

		if(!data.entries[i].choice || !data.entries[i].choice_id) {
			continue;
		}

		questions[data.entries[i].question_id].choices.push({
			text: data.entries[i].choice,
			choice_id: data.entries[i].choice_id
		});

	}

	resultsContent.innerHTML = '<h1>Pizza My Mind Survey</h1>';

	var parsedQuestions = [];

	var questionsContainer = document.createElement('div');
	questionsContainer.className = 'survey-question-container';

	// iterate through questions
	for(var i in questions) {

		// save parsed question
		parsedQuestions.push(questions[i]);

		// save assigned question index
		questions[i]._index = parsedQuestions.length - 1;

		var surveyQuestion = document.createElement('div');
		surveyQuestion.className = 'survey-question';

		var surveyQuestionHeader = document.createElement('span');
		surveyQuestionHeader.className = 'question_header';
		surveyQuestionHeader.innerHTML = '<span class="question_num">' + parsedQuestions.length + '.</span> ';
		surveyQuestionHeader.innerHTML += '<span class="question_title">' + questions[i].question + '</span>';

		var surveyQuestionBody = document.createElement('span');
		surveyQuestionBody.className = 'question_body';


		if(questions[i].type == SURVEY_QUESTION_MULT_CHOICE) {

			for(var x = 0; x < questions[i].choices.length; x++) {

				var surveyQuestionChoice = document.createElement('span');
				surveyQuestionChoice.className = 'question_choice';
				surveyQuestionChoice.question_index = parsedQuestions.length - 1;
				surveyQuestionChoice.choice_id = questions[i].choices[x].choice_id;
				surveyQuestionChoice.innerHTML = questions[i].choices[x].text;
				
				$(surveyQuestionChoice).on('click', function() {

					for(var y = 0; y < this.parentNode.children.length; y++) {
						this.parentNode.children[y].style.backgroundColor = '';
						this.parentNode.children[y].style.color = '';
					}

					this.style.backgroundColor = '#9ea2ff';
					this.style.color = 'rgb(0,5,108)';

					parsedQuestions[this.question_index].answered = true;
					parsedQuestions[this.question_index].response_text = this.innerHTML;
					parsedQuestions[this.question_index].choice_id = this.choice_id;
				});

				surveyQuestionBody.appendChild(surveyQuestionChoice);
			}

		} else if(questions[i].type == SURVEY_QUESTION_FREE_RESP) {

			var surveyQuestionTextArea = document.createElement('textarea');
			surveyQuestionTextArea.className = 'question_text';
			surveyQuestionTextArea.maxLength = '400';
			surveyQuestionTextArea.question_index = parsedQuestions.length - 1;
			surveyQuestionTextArea.placeholder = 'Please type your answer here.';

			callbackOnSurveySubmitButtonPressed(function() {
				
				var question = this;
				parsedQuestions[this.question_index].response_text = this.value;

			}.bind(surveyQuestionTextArea));

			surveyQuestionBody.appendChild(surveyQuestionTextArea);

		}

		surveyQuestion.appendChild(surveyQuestionHeader);
		surveyQuestion.appendChild(surveyQuestionBody);
		questionsContainer.appendChild(surveyQuestion);
	}

	resultsContent.appendChild(questionsContainer);

	// manually append last question asking for CRN
	var crnQuestion = document.createElement('div');
	crnQuestion.className = 'survey-question';

	var crnQuestionHeader = document.createElement('span');
	crnQuestionHeader.className = 'question_header';
	crnQuestionHeader.innerHTML = '<span class="question_num">' + (parsedQuestions.length + 1) + '.</span> ';
	crnQuestionHeader.innerHTML += '<span class="question_title">Please enter the <b>CRN</b> (Course Registration Number) of the course you would like to apply your extra credit to below.</span>';

	var crnQuestionBody = document.createElement('span');
	crnQuestionBody.className = 'question_body';

	var crnQuestionInput = document.createElement('input');
	crnQuestionInput.className = 'question_text_input';
	crnQuestionInput.placeholder = 'Please type your CRN here.';

	crnQuestionBody.appendChild(crnQuestionInput);
	crnQuestion.appendChild(crnQuestionHeader);
	crnQuestion.appendChild(crnQuestionBody);
	questionsContainer.appendChild(crnQuestion);


	// append submit button
	var submitButton = document.createElement('div');
	submitButton.className = 'submit-button';
	submitButton.innerHTML = '<span>Submit Survey</span>';
	resultsContent.appendChild(submitButton);

	// add callback to submit button to check if all answers have been answered
	callbackOnSurveySubmitButtonPressed(function(submitButton) {

		var allQuestionsAnswered = true;

		for(var i = 0; i < parsedQuestions.length; i++) {
			if(parsedQuestions[i].type == SURVEY_QUESTION_MULT_CHOICE && !parsedQuestions[i].answered) {
				allQuestionsAnswered = false;
				break;
			}
		}

		// make sure all multiple-choice questions have been answered
		// and a valid course registration number has been provided
		if(!allQuestionsAnswered) {
			submitButton.hasBeenClicked = false;
			return showAlert('Please answer all questions before pressing submit.');
		} else if(!crnQuestionInput.value || !crnQuestionInput.value.match(/^[0-9]{4}$/gi)) {
			submitButton.hasBeenClicked = false;
			return showAlert('Please provide a valid Course Registration Number!');
		}

		submitButton.innerHTML = '<span>Loading, please wait...</span>';

		// if we have made it this far, assume everything is good to go
		socket.emit('registerapistudentsurveysubmit', {
			crn: crnQuestionInput.value,
			entries: parsedQuestions,
			student_id: data.id
		});

	}.bind(submitButton));

	$(submitButton).on('click', function() {

		// do not allow more than one click
		if(this.hasBeenClicked) {
			return;
		}

		this.hasBeenClicked = true;

		// iterate through all submit button callbacks
		for(var i = 0; i < callbackOnSurveySubmitButtonPressed.callbacks.length; i++) {
			callbackOnSurveySubmitButtonPressed.callbacks[i].call(null, this);
		}

	});

	// handle server response
	onSocketResponse('registerapistudentsurveysubmitresponse', function(data) {

		if(data.error) {
			return showAlert('An error ocurred submitting your survey responses. Please contact clarem@cnu.edu regarding this issue.');
		}

		showHomeResultsPage(data.student_id);
		showAlert('Thank you for your feedback! Your answers have been recorded.');

	});
}

/**
 * Called once server responds with API registration data
 */
function handleServerEmailRegisterResponse(data) {

	if(data.error && data.unauthorized) {
		return resultsContent.innerHTML = 'You do not have permission to request access to this API. Please contact <a href="mailto:clarem@cnu.edu">Clare Maliniak</a> for more information.';
	}

	if(data.error && !data.unauthorized) {
		return resultsContent.innerHTML = 'An error occurred processing your request. Don\'t worry, it\'s not your fault! Please try again later.';
	}

	// email is authorized, exists in database
	// but is already active, email out key
	if(data.entry && data.entry.isActive && data.entry.hashKey) {
		return resultsContent.innerHTML = 'You have already requested access to this API. Please check your email. Your existing key has been sent to you.';
	}

	// email is authorized, exists in database
	// is not active, get hash returned by the server
	resultsContent.innerHTML = 'Thank you for your interest in creating with the Pizza Mind API.<br /><br />';
	resultsContent.innerHTML += 'An email has been sent to you containing your access key.<br />';
	resultsContent.innerHTML += 'To use the API, simply send an "Authentication" header with your request, containing the value "email=YOUR_EMAIL; key=KEY_HASH_EMAILED_TO_YOU"';
}

function handleKeypress(key) {

	if(key == 13) {

		if(!mainInput || mainInput.value == '') {
			return;
		}

		if(!isMainPage) {

			if(isPage == PAGE_REGISTER) {

				var cnuEmail = mainInput.value;

				if(!mainInput.value.match(/^[a-z\-\_\.]+(\.[0-9]+)*\@(cnu\.edu)$/gi)) {
					mainInput.value = '';
					mainInput.placeholder = 'Enter a valid CNU email';
					return;
				}

				mainInput.value = '';
				mainInput.placeholder = 'Loading, please wait...';

				return showRegisterResultsPage(cnuEmail);

			} else if(isPage == PAGE_ADMIN) {
				return handleAdminAuthentication();
			}
		}

		var studentId = mainInput.value;

		// assume we are submitting student ID
		if(!mainInput.value.match(/^(0*)[0-9]{5,8}$/gi)) {
			mainInput.value = '';
			mainInput.placeholder = 'Please enter a valid ID';
			return;
		}

		mainInput.value = '';
		mainInput.placeholder = 'Loading, please wait...';

		return showHomeResultsPage(studentId);
	
	}
}

</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62273783-2', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
